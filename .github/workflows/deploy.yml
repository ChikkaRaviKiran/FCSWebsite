name: Deploy to Ubuntu Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -euo pipefail

            REMOTE_DIR="${{ secrets.REMOTE_DIR }}"
            if [ -z "$REMOTE_DIR" ]; then
              REMOTE_DIR=/var/www/fcs
            fi

            # Ensure directory exists
            mkdir -p "$REMOTE_DIR"

            # Install basic tools if missing (git, curl)
            if ! command -v git >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y git curl
            fi

            # Install Node.js if missing (Node 18 LTS) and ensure npm exists
            if ! command -v node >/dev/null 2>&1 || ! command -v npm >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo DEBIAN_FRONTEND=noninteractive apt-get install -y nodejs npm || sudo DEBIAN_FRONTEND=noninteractive apt-get install -y nodejs
              # Ensure `node` symlink exists (some distros provide `nodejs` only)
              if [ ! -x "/usr/bin/node" ] && [ -x "/usr/bin/nodejs" ]; then
                sudo ln -sf /usr/bin/nodejs /usr/bin/node
              fi
            fi

            # Clone or update repo into REMOTE_DIR
            if [ -d "$REMOTE_DIR/.git" ]; then
              cd "$REMOTE_DIR"
              git fetch --all
              git reset --hard origin/main
            else
              git clone https://github.com/${{ github.repository }} "$REMOTE_DIR"
              cd "$REMOTE_DIR"
            fi

            # Install dev dependencies, build, then prune to production
            npm ci
            npm run build
            npm prune --production || true

            # Restart systemd service (SSH user needs sudo privileges)
            sudo systemctl daemon-reload || true
            sudo systemctl restart fcs.service || sudo systemctl start fcs.service || true
